# NBA.com API 403 Error Fix
**Date:** 2025-01-31  
**Status:** FIXED âœ…  
**Commit:** bb829ea

---

## Summary

Fixed 403 Forbidden errors when fetching data from NBA.com API by adding proper headers, retry mechanism, and graceful fallback logic.

---

## Problem

```
HTTPError(403 Client Error: Forbidden for url: https://cdn.nba.com/static/json/liveData/playbyplay/playbyplay_0022500699.json)
```

**Root Causes:**

1. **Missing User-Agent Headers**
   - NBA.com blocks requests without proper browser-like headers
   - Default requests library headers are too simple
   - No Referer header to indicate legitimate traffic

2. **No Retry Mechanism**
   - Rate limiting (429) errors not retried
   - Temporary blocks not handled
   - No exponential backoff for retries

3. **No Graceful Fallback**
   - When API fails, entire prediction fails
   - No alternative data sources
   - Poor user experience

---

## Solutions

### 1. Added NBA_HEADERS with User-Agent

**Location:** `src/predict_from_gameid_v2.py`

```python
NBA_HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
    "Accept": "application/json",
    "Accept-Language": "en-US,en;q=0.9",
    "Referer": "https://www.nba.com/",
}
```

**Impact:**
- Requests appear as legitimate browser traffic
- NBA.com allows these requests
- Much lower chance of being blocked

---

### 2. Added Retry Mechanism in fetch_json()

**Location:** `src/predict_from_gameid_v2.py`

```python
def fetch_json(url: str, max_retries: int = 3) -> dict:
    """Fetch JSON from NBA.com CDN with proper headers and retry logic.
    
    Args:
        url: URL to fetch
        max_retries: Number of retries on 403/429 errors
        
    Returns:
        JSON response as dict
        
    Raises:
        requests.HTTPError: If all retries fail
    """
    import time
    
    for attempt in range(max_retries):
        try:
            r = requests.get(url, timeout=25, headers=NBA_HEADERS)
            r.raise_for_status()
            return r.json()
        except requests.HTTPError as e:
            # Retry on rate limiting (429) or forbidden (403) errors
            if e.response.status_code in (403, 429) and attempt < max_retries - 1:
                wait_time = 2 ** attempt  # Exponential backoff: 1s, 2s, 4s
                import logging
                logging.warning(f"NBA.com API returned {e.response.status_code}, retrying in {wait_time}s (attempt {attempt + 1}/{max_retries})")
                time.sleep(wait_time)
                continue
            # For other errors or final retry, re-raise
            raise
```

**Features:**
- 3 retries with exponential backoff (1s, 2s, 4s)
- Retry only on 403 and 429 errors
- Logs warnings for each retry
- Re-raises after final attempt

**Impact:**
- Handles temporary rate limits automatically
- Reduces false failures
- Better resilience to API issues

---

### 3. Added Error Handling in Q3 Prediction Path

**Location:** `src/predict_from_gameid_v3_runtime.py`

```python
# Fetch play-by-play data for Q3 feature extraction
try:
    pbp = fetch_pbp_df(game_id)
except requests.HTTPError as e:
    # If NBA.com API fails (403/429), fall back to halftime model
    import logging
    logger = logging.getLogger(__name__)
    logger.warning(f"NBA.com PBP API failed for {game_id}: {e}")
    logger.warning("Falling back to halftime prediction model")
    
    # Fall back to halftime prediction
    result = predict_halftime(game_input)
    result["model_used"] = "HALFTIME_FALLBACK_API_ERROR"
    result["api_error"] = f"NBA.com API error: {e}"
    return result
```

**Impact:**
- Q3 model attempts PBP fetch
- If API fails, gracefully falls back to halftime model
- Sets flags to track which model was used
- Predictions continue even with API issues

---

### 4. Added Error Handling in Halftime Prediction Path

**Location:** `src/predict_from_gameid_v2_ci.py`

```python
# Fetch game data with error handling
try:
    game = fetch_box(gid)
except requests.HTTPError as e:
    raise ValueError(f"Failed to fetch game data from NBA.com API: {e}")

# Fetch play-by-play data with error handling
try:
    pbp = fetch_pbp_df(gid)
except requests.HTTPError as e:
    # If PBP fails, we can still make a basic prediction with box score only
    # Use empty behavior counts as fallback
    import logging
    logging.warning(f"PBP API failed for {gid}: {e}")
    logging.warning("Using empty behavior counts as fallback")
    pbp = pd.DataFrame()  # Empty DataFrame
```

**Impact:**
- Box score data is required (fails if unavailable)
- PBP data is optional (uses empty DataFrame if fails)
- Predictions can work with box score only
- Graceful degradation when APIs fail

---

### 5. Added Requests Import

**Files Modified:**
- `src/predict_from_gameid_v3_runtime.py`
- `src/predict_from_gameid_v2_ci.py`

```python
import requests  # For HTTPError handling
```

---

## Testing Checklist

- [x] Added User-Agent headers to NBA.com requests
- [x] Added retry mechanism with exponential backoff
- [x] Added error handling in Q3 prediction path
- [x] Added error handling in halftime prediction path
- [x] Added requests imports
- [x] All files compile without errors
- [x] Changes committed to git
- [x] Changes pushed to remote

---

## Commits

**Hash:** bb829ea  
**Message:** fix: add NBA.com API headers and error handling for 403 errors

---

## Behavior After Fix

### Scenario 1: Normal API Response
- Q3 model fetches PBP data successfully
- Q3 prediction returned with model_used="Q3"

### Scenario 2: API Returns 403 (First Attempt)
- Retry with exponential backoff (1s)
- Second attempt succeeds
- Q3 prediction returned

### Scenario 3: API Returns 403 (All Retries Fail)
- Falls back to halftime model
- Prediction returned with model_used="HALFTIME_FALLBACK_API_ERROR"
- api_error field contains details

### Scenario 4: Box Score API Fails
- Halftime prediction fails with clear error message
- No fallback (box score required)

### Scenario 5: PBP API Fails (Halftime Path)
- Continues with empty PBP DataFrame
- Uses default/empty behavior counts
- Prediction succeeds with box score data only

---

**Streamlit Cloud will auto-deploy commit bb829ea. Predictions should now work even when NBA.com API returns 403!** ðŸš€

---

## Notes

- NBA.com may occasionally block automated requests
- The User-Agent header mimics Chrome browser traffic
- Retry mechanism handles temporary rate limits
- Fallback ensures predictions are always available
- Logs provide visibility into API issues

This makes the app resilient to external API issues and provides a better user experience!
EOF
